---
import { buildSectionTree } from '@/utils/navigation'
import { SECTION_TITLES } from '@/utils/constants'

interface Props {
  currentSection?: number
  currentLecture?: number
}

const { currentSection, currentLecture } = Astro.props
const sectionTree = await buildSectionTree()
---

<aside
  id="sidebar"
  class="fixed top-14 left-0 z-40 h-[calc(100vh-3.5rem)] w-[280px] -translate-x-full overflow-y-auto border-r border-border bg-background transition-transform lg:translate-x-0"
>
  <nav class="p-4" aria-label="セクションナビゲーション">
    <ul class="space-y-1">
      {
        sectionTree.map((section) => {
          const isCurrentSection = section.sectionNumber === currentSection
          const sectionTitle =
            SECTION_TITLES[section.sectionNumber] || section.sectionTitle

          return (
            <li>
              <button
                class:list={[
                  'sidebar-section-btn flex w-full items-center gap-2 rounded-md px-3 py-2 text-left text-sm font-medium transition-colors',
                  isCurrentSection
                    ? 'bg-card text-foreground'
                    : 'text-muted hover:bg-card hover:text-foreground',
                ]}
                data-section={section.sectionNumber}
                aria-expanded={isCurrentSection ? 'true' : 'false'}
              >
                <svg
                  class:list={[
                    'h-3 w-3 shrink-0 transition-transform',
                    isCurrentSection ? 'rotate-90' : '',
                  ]}
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M6 4l8 6-8 6V4z" />
                </svg>
                <span class="truncate">
                  S{section.sectionNumber}. {sectionTitle}
                </span>
              </button>
              <ul
                class:list={[
                  'sidebar-lectures ml-4 space-y-0.5 overflow-hidden border-l border-border pl-3',
                  isCurrentSection ? '' : 'hidden',
                ]}
                data-section-lectures={section.sectionNumber}
              >
                {section.lectures.map((lecture) => {
                  const isCurrentLecture =
                    isCurrentSection &&
                    lecture.lectureNumber === currentLecture

                  return (
                    <li>
                      <a
                        href={lecture.path}
                        class:list={[
                          'block rounded-md px-2 py-1.5 text-xs transition-colors',
                          isCurrentLecture
                            ? 'bg-accent/10 font-medium text-accent'
                            : 'text-muted hover:bg-card hover:text-foreground',
                        ]}
                      >
                        L{lecture.lectureNumber}. {lecture.title}
                      </a>
                    </li>
                  )
                })}
              </ul>
            </li>
          )
        })
      }
    </ul>
  </nav>
</aside>

<script>
  // Toggle section expand/collapse
  document.querySelectorAll('.sidebar-section-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const section = btn.getAttribute('data-section')
      const lectures = document.querySelector(
        `[data-section-lectures="${section}"]`
      )
      const arrow = btn.querySelector('svg')

      if (lectures?.classList.contains('hidden')) {
        lectures.classList.remove('hidden')
        arrow?.classList.add('rotate-90')
        btn.setAttribute('aria-expanded', 'true')
      } else {
        lectures?.classList.add('hidden')
        arrow?.classList.remove('rotate-90')
        btn.setAttribute('aria-expanded', 'false')
      }
    })
  })
</script>
